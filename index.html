<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phone Movement Direction (Less Sensitive)</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, sans-serif; display:flex; flex-direction:column; gap:12px; align-items:center; padding:20px; }
    .box { width:260px; height:260px; border-radius:12px; display:flex; align-items:center; justify-content:center; border:2px solid #222; }
    .dir { font-size:32px; font-weight:700; }
    .vals { font-family: monospace; white-space:pre; text-align:left; }
    button { padding:10px 14px; font-size:16px; }
    #controls { display:flex; gap:10px; }
  </style>
</head>
<body>
  <h2>Movement direction (less sensitive)</h2>
  <div id="controls">
    <button id="start">Start sensors / Request permission</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <div class="box">
    <div class="dir" id="direction">—</div>
  </div>
  <div class="vals" id="vals">waiting…</div>

<script>
(() => {
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');
  const dirEl = document.getElementById('direction');
  const vals = document.getElementById('vals');

  let motionListener = null;
  let running = false;

  // Gravity estimate
  let gravity = { x: 0, y: 0, z: 0 };
  const alpha = 0.97; // smoother (less responsive) gravity filter

  // Less sensitive threshold
  let threshold = 1.0; // m/s^2 (raise to require stronger movement)

  // Debounce
  let lastDir = null;
  let lastChange = 0;
  const debounceMs = 300;

  function classify(linear) {
    const ax = linear.x, ay = linear.y;
    const absX = Math.abs(ax), absY = Math.abs(ay);
    const now = Date.now();

    if (absX < threshold && absY < threshold) {
      if (now - lastChange > debounceMs) {
        lastDir = 'still';
        dirEl.textContent = 'still';
      }
      return;
    }

    let dir = 'unknown';
    if (absX >= absY) {
      dir = ax > 0 ? 'right' : 'left';
    } else if (absY >= absX) {
      dir = ay > 0 ? 'down' : 'up';
    }

    if (dir !== lastDir && now - lastChange > debounceMs) {
      lastDir = dir;
      lastChange = now;
      dirEl.textContent = dir;
    }
  }

  function onMotion(e) {
    const acc = e.acceleration && e.acceleration.x !== null
      ? e.acceleration
      : e.accelerationIncludingGravity;
    if (!acc) return;

    gravity.x = alpha * gravity.x + (1 - alpha) * (acc.x || 0);
    gravity.y = alpha * gravity.y + (1 - alpha) * (acc.y || 0);

    const lin = {
      x: (acc.x || 0) - gravity.x,
      y: (acc.y || 0) - gravity.y,
      // z: (acc.z || 0) - gravity.z
    };

    vals.textContent =
      `acc: x:${(acc.x||0).toFixed(2)} y:${(acc.y||0).toFixed(2)}` +
      `lin: x:${lin.x.toFixed(2)} y:${lin.y.toFixed(2)}` +
      `threshold: ${threshold.toFixed(2)} m/s²`;

    classify(lin);
  }

  function startSensors() {
    if (running) return;
    running = true;
    const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent);
    const attach = () => {
      motionListener = onMotion;
      window.addEventListener('devicemotion', motionListener, { passive: true });
      startBtn.disabled = true;
      stopBtn.disabled = false;
      dirEl.textContent = '—';
    };
    if (isIOS && typeof DeviceMotionEvent?.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission()
        .then(res => {
          if (res === 'granted') attach();
          else alert('Permission denied for device motion.');
        })
        .catch(err => alert('DeviceMotion permission error: ' + err));
    } else {
      attach();
    }
  }

  function stopSensors() {
    if (!running) return;
    running = false;
    if (motionListener) {
      window.removeEventListener('devicemotion', motionListener);
      motionListener = null;
    }
    startBtn.disabled = false;
    stopBtn.disabled = true;
    dirEl.textContent = 'stopped';
  }

  startBtn.addEventListener('click', startSensors);
  stopBtn.addEventListener('click', stopSensors);
})();
</script>
</body>
</html>
